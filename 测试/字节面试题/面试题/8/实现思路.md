# 图片懒加载组件实现思路

## 核心问题解答

### 1. img 该怎么占位？

**方案一：使用占位图（Placeholder）**
- 用一个小的 base64 图片或占位符 URL
- 例如：`data:image/svg+xml,<svg>...</svg>` 或 1x1 透明像素
- 优点：保持布局稳定，避免 CLS（累积布局偏移）

**方案二：使用 data-src 属性**
- 将真实图片 URL 放在 `data-src` 中
- `<img>` 标签不设置 `src` 或使用占位图
- 进入可视区域后，将 `data-src` 赋值给 `src`

**方案三：显示 Loading 状态**
- 显示一个加载中的占位元素（可以是骨架屏或 loading 图标）
- 图片加载完成后替换

### 2. src 不写会怎么样？

**不写 src 的问题：**
- ✅ 浏览器不会发起请求（符合懒加载目标）
- ❌ 但 `<img>` 标签会显示破损图标（浏览器默认行为）
- ❌ 可能导致布局不稳定（如果图片没有固定宽高）

**解决方案：**
1. **使用 data-src**：`<img data-src="真实URL" />`
2. **使用占位图**：`<img src="占位图" data-src="真实URL" />`
3. **设置固定宽高**：避免布局抖动

## 实现方案

### 方案一：Intersection Observer（推荐）⭐

**优点：**
- 性能好，不触发回流
- 浏览器原生 API，无需手动计算位置
- 支持预加载（rootMargin）

**实现步骤：**
1. 使用 `IntersectionObserver` 监听图片元素
2. 图片进入可视区域时，将 `data-src` 赋值给 `src`
3. 加载完成后取消观察

### 方案二：滚动事件 + getBoundingClientRect

**缺点：**
- 需要手动计算位置
- 可能触发回流（reflow）
- 需要节流优化

## 核心实现思路

```javascript
// 1. 使用 IntersectionObserver 监听
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      // 图片进入可视区域
      const img = entry.target;
      img.src = img.dataset.src; // 加载真实图片
      observer.unobserve(img); // 取消观察
    }
  });
});

// 2. 观察所有需要懒加载的图片
images.forEach(img => observer.observe(img));
```

## 占位处理方案

### 方案 A：占位图（Placeholder）
```jsx
<img 
  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3C/svg%3E"
  data-src={realSrc}
  alt={alt}
/>
```

### 方案 B：骨架屏占位
```jsx
{!loaded ? (
  <div className="skeleton">加载中...</div>
) : (
  <img src={src} alt={alt} />
)}
```

### 方案 C：固定尺寸占位
```jsx
<img 
  width={width}
  height={height}
  style={{ backgroundColor: '#f0f0f0' }}
  data-src={src}
/>
```

## 性能优化

1. **预加载**：使用 `rootMargin` 提前加载
   ```javascript
   new IntersectionObserver(callback, {
     rootMargin: '50px' // 提前 50px 开始加载
   })
   ```

2. **固定尺寸**：设置 `width` 和 `height`，避免布局抖动

3. **取消观察**：图片加载后立即取消观察，减少监听数量

4. **错误处理**：监听 `onerror` 事件，显示错误占位图

## 最佳实践

1. ✅ 使用 Intersection Observer API
2. ✅ 设置固定宽高避免布局抖动
3. ✅ 使用占位图或骨架屏
4. ✅ 支持预加载（rootMargin）
5. ✅ 错误处理和加载状态
6. ✅ 组件卸载时清理 Observer

详见 `1.js` 文件中的实现

